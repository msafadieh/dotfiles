#! /bin/sh
LOCATION=$1
# run every 60 minutes

weather() {
    local weather
    
    weather=$(curl http://wttr.in/$LOCATION\?m\&format\=%C%20@%20%t --connect-timeout 1)

    if [ $(wc -c <<< $weather) -lt 50 ]; then 
        # first part all lowercase
        WEATHER="$(awk -F '@' '/@/ {print tolower($1) "@" $2}' <<< $weather)"
    else
        # rate limits
        WEATHER=error
    fi
}

ram() {
    RAM="$(free --mega | awk '/Mem/ {print $3}')MB"
}

datetime() {
	DATETIME="$(date +"%a %d %B @ %H:%M" | tr "[:upper:]" "[:lower:]")"
}

volume() {
    local sinks mute

    sinks="$(pactl list sinks)"
    mute="$(awk '/Mute/ {l=$2} END {print l}' <<< $sinks)"
    VOLUME="$(awk '/[0-9]+%/ {pl = l; l = $5} END {print pl}' <<< $sinks)"

    if [ $mute = "yes" ]; then
        VOLUME=$VOLUME~
	fi
}

battery() {
    local battery ac

    battery=$(< /sys/class/power_supply/BAT0/capacity)
    ac=$(< /sys/class/power_supply/AC/online)

    if [ $ac != "0" ] || [ $battery -gt 15 ] || [ -z $BAT_LOW ]; then
        BAT_CRITIC=0
        BAT_LOW=0
    elif [ $battery -le 5 ]; then
        [ $BAT_CRITIC -eq 0 ] && notify-send -u critical "Critical low battery warning ($battery%)"
        BAT_CRITIC=1
    elif [ $battery -le 15 ]; then
        [ $BAT_LOW -eq 0 ] && notify-send "Low battery warning ($battery %)"
        BAT_LOW=1
    fi

    
    BATTERY="$battery%"
    if [ $ac != "0" ]; then
        BATTERY=$BATTERY^
    fi
    
}


function network() {
	output=$(nmcli)
	if grep 'en[a-z0-9]+: connected' <<< "$output"; then
		NETWORK="ethernet"
	else
		wifi=$(awk '/wl[a-z0-9]+: connected/ { s = $4; for (i = 5; i <= NF; i++) { s = s " " $i  }; print s }' <<< "$output")
		if [ -z "$wifi" ]; then
			NETWORK="disconnected"
		else
			NETWORK=$wifi
		fi
	fi
}

while :
do
    weather
    for run in {1..3600}
    do
        network
        # run every second
        for run in {1..5}
        do
        	ram
            datetime 
            volume
            battery
			str="[ $NETWORK ] [ $VOLUME ] [ $RAM ] [ $BATTERY ] [ $WEATHER ] [ $DATETIME ]"
            #xsetroot -name "$str"
			echo "$str"
			sleep 1 
        done
        # break on blank weather
        [ -z "$WEATHER" ] && break
    done
done

